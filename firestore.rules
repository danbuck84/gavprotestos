rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin' ||
         request.auth.uid == '76561197991580442');
    }

    function isSuperAdmin() {
      return isAuthenticated() && request.auth.uid == '76561197991580442';
    }

    // Users: Auth can read, Admin can write (except own profile update which is allowed)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // For first login
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isSuperAdmin();
      
      // Notifications sub-collection: User can read/write (mark as read)
      match /notifications/{notificationId} {
        allow read: if request.auth.uid == userId;
        allow update: if request.auth.uid == userId; // To mark as read
        allow create: if false; // Created by backend only
        allow delete: if false;
      }
    }

    // Protests: Auth can read/create, Admin can update
    match /protests/{protestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      
      // Votes sub-collection: Only admins can read and write
      match /votes/{voteId} {
        allow read: if isAdmin();
        allow create: if isAdmin();
        allow update: if false; // Votes are immutable
        allow delete: if false;
      }
    }

    // Feedback: Auth can create their own, Admins can read/update
    match /feedback/{feedbackId} {
      // Usuários autenticados podem criar feedback
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Usuários podem ler seus próprios feedbacks + Admins podem ler todos
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // Apenas admins podem atualizar (marcar como lido)
      allow update: if isAdmin();
      
      // Apenas super-admins podem deletar
      allow delete: if isSuperAdmin();
    }

    // Races: Auth can read, Admin can write
    match /races/{raceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
